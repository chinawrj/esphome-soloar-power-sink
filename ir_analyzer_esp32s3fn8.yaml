esphome:
  name: ir-analyzer-s3fn8
  friendly_name: IR Analyzer ESP32-S3FN8
  comment: Standalone IR receiver and transmitter for ESP32-S3FN8 board
  on_boot:
    priority: -10
    then:
      - logger.log: 
          format: "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          level: INFO
      - logger.log:
          format: "ğŸš€ ESP32-S3FN8 IR Analyzer Started"
          level: INFO  
      - logger.log:
          format: "ğŸ“¡ IR RX: GPIO1 | IR TX: GPIO2 (SWAPPED)"
          level: INFO
      - logger.log:
          format: "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          level: INFO

esp32:
  board: m5stack-atoms3
  variant: esp32s3
  framework:
    type: arduino

# æ—¥å¿—é…ç½® - USB CDCä¸²å£è¾“å‡º
logger:
  level: DEBUG
  hardware_uart: USB_CDC
  logs:
    component: ERROR
    sensor: INFO

# ç¦ç”¨WiFi - çº¯æœ¬åœ°è¿è¡Œ
wifi:
  manual_ip:
    static_ip: 192.168.1.99
    gateway: 192.168.1.1
    subnet: 255.255.255.0
  ssid: "dummy_ssid"
  password: "dummy12345"
  enable_on_boot: false

# å…¨å±€å˜é‡å­˜å‚¨ç»Ÿè®¡ä¿¡æ¯
globals:
  - id: total_signals_received
    type: int
    initial_value: '0'
  - id: last_nec_address
    type: uint16_t
    initial_value: '0'
  - id: last_nec_command
    type: uint16_t  
    initial_value: '0'
  # å­˜å‚¨æœ€åæ¥æ”¶çš„åŸå§‹IRæ•°æ®ï¼ˆæµ·å°”ç”µè§†é¥æ§å™¨ï¼‰
  - id: last_raw_data
    type: std::vector<int32_t>
    restore_value: false
  - id: has_raw_data
    type: bool
    initial_value: 'false'
  # æ ‡è®°æ˜¯å¦æ­£åœ¨å‘é€ï¼ˆç”¨äºåŒºåˆ†è‡ªå·±å‘é€çš„ä¿¡å·ï¼‰
  - id: is_transmitting
    type: bool
    initial_value: 'false'

# çº¢å¤–æ¥æ”¶å™¨é…ç½® - GPIO1 (å¯¹è°ƒæµ‹è¯•)
remote_receiver:
  id: ir_receiver
  pin: 
    number: GPIO1
    mode:
      input: true
      pullup: true
  dump: all  # å¼€å¯æ‰€æœ‰åè®®çš„è‡ªåŠ¨dumpï¼Œä¾¿äºè°ƒè¯•
  tolerance: 30%  # å¢åŠ å®¹å·®ä»¥åŒ¹é…æ›´å¤šåè®®å˜ç§
  filter: 50us
  idle: 4ms
  buffer_size: 10kb
  
  # NECåè®®å¤„ç†
  on_nec:
    then:
      - lambda: |-
          id(total_signals_received) += 1;
          id(last_nec_address) = x.address;
          id(last_nec_command) = x.command;
          
          ESP_LOGI("IR-NEC", "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
          ESP_LOGI("IR-NEC", "â•‘         NEC Protocol Detected        â•‘");
          ESP_LOGI("IR-NEC", "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
          ESP_LOGI("IR-NEC", "â•‘ Address : 0x%04X                    â•‘", x.address);
          ESP_LOGI("IR-NEC", "â•‘ Command : 0x%04X                    â•‘", x.command);
          ESP_LOGI("IR-NEC", "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

  # Samsungåè®®å¤„ç†
  on_samsung:
    then:
      - lambda: |-
          id(total_signals_received) += 1;
          
          ESP_LOGI("IR-Samsung", "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
          ESP_LOGI("IR-Samsung", "â•‘      Samsung Protocol Detected       â•‘");
          ESP_LOGI("IR-Samsung", "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
          ESP_LOGI("IR-Samsung", "â•‘ Data    : 0x%08X              â•‘", x.data);
          ESP_LOGI("IR-Samsung", "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

  # Sonyåè®®å¤„ç†
  on_sony:
    then:
      - lambda: |-
          id(total_signals_received) += 1;
          
          ESP_LOGI("IR-Sony", "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
          ESP_LOGI("IR-Sony", "â•‘        Sony Protocol Detected        â•‘");
          ESP_LOGI("IR-Sony", "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
          ESP_LOGI("IR-Sony", "â•‘ Data    : 0x%08X              â•‘", x.data);
          ESP_LOGI("IR-Sony", "â•‘ Bits    : %d                         â•‘", x.nbits);
          ESP_LOGI("IR-Sony", "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

  # RC5åè®®å¤„ç†
  on_rc5:
    then:
      - lambda: |-
          id(total_signals_received) += 1;
          
          ESP_LOGI("IR-RC5", "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
          ESP_LOGI("IR-RC5", "â•‘       RC5 Protocol Detected          â•‘");
          ESP_LOGI("IR-RC5", "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
          ESP_LOGI("IR-RC5", "â•‘ Address : 0x%02X                      â•‘", x.address);
          ESP_LOGI("IR-RC5", "â•‘ Command : 0x%02X                      â•‘", x.command);
          ESP_LOGI("IR-RC5", "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

  # LGåè®®å¤„ç†
  on_lg:
    then:
      - lambda: |-
          id(total_signals_received) += 1;
          
          ESP_LOGI("IR-LG", "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
          ESP_LOGI("IR-LG", "â•‘         LG Protocol Detected         â•‘");
          ESP_LOGI("IR-LG", "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
          ESP_LOGI("IR-LG", "â•‘ Data    : 0x%08X              â•‘", x.data);
          ESP_LOGI("IR-LG", "â•‘ Bits    : %d                         â•‘", x.nbits);
          ESP_LOGI("IR-LG", "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

  # åŸå§‹ä¿¡å·å¤„ç† - æœªçŸ¥åè®®ï¼ˆæµ·å°”ç”µè§†é¥æ§å™¨ï¼‰
  on_raw:
    then:
      - lambda: |-
          if (x.size() < 10) {
            return;
          }
          
          // å¦‚æœæ˜¯è‡ªå·±å‘é€çš„ä¿¡å·ï¼Œå¿½ç•¥ä¸ä¿å­˜ï¼ˆé˜²æ­¢æ³¢å½¢é€€åŒ–ï¼‰
          if (id(is_transmitting)) {
            ESP_LOGI("IR-RAW", "â­ï¸  Ignoring self-transmitted signal (preventing waveform degradation)");
            return;
          }
          
          id(total_signals_received) += 1;
          
          // åªä¿å­˜å¤–éƒ¨é¥æ§å™¨ä¿¡å·
          id(last_raw_data).clear();
          for (auto val : x) {
            id(last_raw_data).push_back(val);
          }
          id(has_raw_data) = true;
          
          ESP_LOGI("IR-RAW", "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
          ESP_LOGI("IR-RAW", "â•‘   Haier TV Remote - Raw Data Saved   â•‘");
          ESP_LOGI("IR-RAW", "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£");
          ESP_LOGI("IR-RAW", "â•‘ Transitions: %d                      ", x.size());
          ESP_LOGI("IR-RAW", "â•‘ First 20 timing values (Î¼s):         â•‘");
          
          std::string timing_str = "";
          for (int i = 0; i < std::min((int)x.size(), 20); i++) {
            char buf[10];
            sprintf(buf, "%d ", x[i]);
            timing_str += buf;
            if ((i + 1) % 5 == 0) {
              ESP_LOGI("IR-RAW", "â•‘ %s", timing_str.c_str());
              timing_str = "";
            }
          }
          if (!timing_str.empty()) {
            ESP_LOGI("IR-RAW", "â•‘ %s", timing_str.c_str());
          }
          
          // åˆ†æå¼•å¯¼ç 
          if (x.size() > 2) {
            int leader_high = abs(x[0]);
            int leader_low = abs(x[1]);
            ESP_LOGI("IR-RAW", "â•‘ Leader: [%d Î¼s, %d Î¼s]", leader_high, leader_low);
            
            if (leader_high > 8000 && leader_high < 10000 && 
                leader_low > 4000 && leader_low < 5000) {
              ESP_LOGI("IR-RAW", "â•‘ Hint: Possibly NEC-like protocol     â•‘");
            }
          }
          
          ESP_LOGI("IR-RAW", "â•‘ âœ… Data stored for retransmission    â•‘");
          ESP_LOGI("IR-RAW", "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");

# çº¢å¤–å‘å°„å™¨é…ç½® - GPIO2 (å¯¹è°ƒæµ‹è¯•)
remote_transmitter:
  id: ir_transmitter
  pin: GPIO2
  carrier_duty_percent: 50%

# è„šæœ¬ï¼šå¼‚æ­¥æ¸…é™¤å‘é€æ ‡å¿—ï¼ˆä¸é˜»å¡ä¸»å¾ªç¯ï¼‰
script:
  - id: clear_transmitting_flag
    mode: restart  # å¦‚æœå·²åœ¨è¿è¡Œï¼Œé‡æ–°å¼€å§‹
    then:
      - delay: 500ms
      - lambda: |-
          id(is_transmitting) = false;
          ESP_LOGD("IR-TX", "âœ… Transmission flag cleared, ready to receive external signals");

# æŒ‰é’®å®šä¹‰ - ç”¨äºçº¢å¤–å‘å°„æµ‹è¯•
button:
  # è½¬å‘æœ€åæ¥æ”¶åˆ°çš„NECç 
  - platform: template
    name: "Transmit Last NEC Code"
    id: transmit_last_nec
    on_press:
      - lambda: |-
          if (id(last_nec_address) != 0 || id(last_nec_command) != 0) {
            ESP_LOGI("IR-TX", "ğŸ“¤ Transmitting NEC: Addr=0x%04X, Cmd=0x%04X", 
                     id(last_nec_address), id(last_nec_command));
          } else {
            ESP_LOGW("IR-TX", "âš ï¸  No NEC code stored to transmit");
            return;
          }
      - remote_transmitter.transmit_nec:
          address: !lambda 'return id(last_nec_address);'
          command: !lambda 'return id(last_nec_command);'

  # å‘é€æµ‹è¯•NECä¿¡å·ï¼ˆç”µæºé”®ç¤ºä¾‹ï¼‰
  - platform: template
    name: "Send Test Power Button"
    on_press:
      - logger.log: "ğŸ“¤ Sending test NEC signal (Power button)..."
      - remote_transmitter.transmit_nec:
          address: 0x00FF
          command: 0x10EF

  # å‘é€æµ‹è¯•NECä¿¡å·ï¼ˆéŸ³é‡+ç¤ºä¾‹ï¼‰
  - platform: template
    name: "Send Test Volume Up"
    on_press:
      - logger.log: "ğŸ“¤ Sending test NEC signal (Volume Up)..."
      - remote_transmitter.transmit_nec:
          address: 0x00FF
          command: 0x18E7

# å®šæ—¶ç»Ÿè®¡æŠ¥å‘Šå’Œå¿ƒè·³æ£€æµ‹
interval:
  # æ¯5ç§’é‡å‘æœ€åæ¥æ”¶çš„åŸå§‹æ•°æ®ï¼ˆæµ·å°”ç”µè§†é¥æ§å™¨ä¿¡å·ï¼‰
  - interval: 5s
    then:
      - if:
          condition:
            lambda: 'return id(has_raw_data) && id(last_raw_data).size() > 0;'
          then:
            - logger.log:
                format: "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                level: INFO
                tag: IR-TX
            - logger.log:
                format: "â•‘  ğŸ” Retransmitting Haier TV Signal   â•‘"
                level: INFO
                tag: IR-TX
            - logger.log:
                format: "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                level: INFO
                tag: IR-TX
            - lambda: |-
                ESP_LOGI("IR-TX", "â•‘ Transitions: %d                      ", id(last_raw_data).size());
                ESP_LOGI("IR-TX", "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
            # å‘é€å‰è®¾ç½®æ ‡å¿—ä½ï¼ˆé˜²æ­¢æ¥æ”¶è‡ªå·±çš„ä¿¡å·ï¼‰
            - lambda: 'id(is_transmitting) = true;'
            - remote_transmitter.transmit_raw:
                carrier_frequency: 38kHz
                code: !lambda 'return id(last_raw_data);'
            # å¼‚æ­¥æ‰§è¡Œè„šæœ¬æ¸…é™¤æ ‡å¿—ï¼ˆä¸é˜»å¡ä¸»å¾ªç¯ï¼‰
            - script.execute: clear_transmitting_flag
          else:
            - lambda: |-
                ESP_LOGI("HEARTBEAT", "ğŸ’“ System alive - Total IR signals: %d", id(total_signals_received));
                
                // è¯»å–GPIO1çš„åŸå§‹ç”µå¹³çŠ¶æ€
                int gpio_level = digitalRead(1);
                ESP_LOGI("GPIO_DEBUG", "ğŸ“Œ GPIO1 (IR RX) level: %d (0=LOW/IR signal, 1=HIGH/idle)", gpio_level);
  
  # æ¯30ç§’è¾“å‡ºç»Ÿè®¡ä¿¡æ¯
  - interval: 30s
    then:
      - lambda: |-
          if (id(total_signals_received) > 0) {
            ESP_LOGI("STATS", "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”");
            ESP_LOGI("STATS", "â”‚       Statistics Report             â”‚");
            ESP_LOGI("STATS", "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤");
            ESP_LOGI("STATS", "â”‚ Total Signals: %d", id(total_signals_received));
            if (id(last_nec_address) != 0 || id(last_nec_command) != 0) {
              ESP_LOGI("STATS", "â”‚ Last NEC Addr: 0x%04X", id(last_nec_address));
              ESP_LOGI("STATS", "â”‚ Last NEC Cmd:  0x%04X", id(last_nec_command));
            }
            ESP_LOGI("STATS", "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜");
          } else {
            ESP_LOGW("STATS", "âš ï¸  No IR signals received yet. Check hardware connection!");
          }

# ç”¨æˆ·æŒ‰é’®ç”¨äºæ‰‹åŠ¨è§¦å‘å‘å°„ï¼ˆGPIO41ï¼‰
binary_sensor:
  - platform: gpio
    pin:
      number: GPIO41
      mode:
        input: true
        pullup: true
      inverted: true
    name: "User Button"
    internal: true
    on_press:
      then:
        - logger.log: "ğŸ”˜ Button pressed - transmitting last NEC code..."
        - button.press: transmit_last_nec

# GPIO1çŠ¶æ€ç›‘æ§ä¼ æ„Ÿå™¨ï¼ˆç”¨äºè°ƒè¯•ï¼‰
sensor:
  - platform: template
    name: "GPIO1 Digital Level"
    id: gpio1_level
    update_interval: 100ms  # æ¯100msè¯»å–ä¸€æ¬¡
    lambda: |-
      return digitalRead(1);
    on_value:
      then:
        - lambda: |-
            static int last_value = -1;
            int current = (int)x;
            if (current != last_value) {
              if (current == 0) {
                ESP_LOGI("GPIO1", "ğŸ”´ Level changed to LOW (IR active or pulled low)");
              } else {
                ESP_LOGI("GPIO1", "ğŸŸ¢ Level changed to HIGH (idle)");
              }
              last_value = current;
            }
